{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Violation Reports - OSA Staff</title>
  <link rel="stylesheet" href="{% static 'violations/css/style.css' %}" />
  <link rel="stylesheet" href="{% static 'violations/css/main.css' %}" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body class="role-staff">
  <header class="top-nav">
    <div class="top-left">
      <a href="{% url 'violations:staff_dashboard' %}" style="display:flex; align-items:center; gap:12px; text-decoration:none; color:inherit;">
        <img src="{% static 'violations/images/chmsu_logo.png' %}" class="header-logo" alt="CHMSU" />
        <span class="header-title">Violation Reports</span>
      </a>
    </div>
    <div class="top-right">
      <a href="{% url 'violations:staff_dashboard' %}" class="icon-btn"><i class="fas fa-home"></i></a>
      <a href="{% url 'violations:staff_export_report' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="login-button">
        <i class="fas fa-download"></i> Export CSV
      </a>
    </div>
  </header>

  <div class="background-overlay"></div>
  <div class="background-image"></div>

  <main class="container" style="position:relative; z-index:3; margin-top: calc(var(--header-height) + 24px);">
    <!-- Date Filter -->
    <section class="card" style="margin-bottom:20px;">
      <form method="get" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
        <div style="flex:0 0 180px;">
          <label style="display:block; margin-bottom:4px; font-weight:500;">Start Date</label>
          <input type="date" name="start_date" value="{{ start_date }}"
                 style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
        </div>
        <div style="flex:0 0 180px;">
          <label style="display:block; margin-bottom:4px; font-weight:500;">End Date</label>
          <input type="date" name="end_date" value="{{ end_date }}"
                 style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
        </div>
        <button type="submit" class="login-button"><i class="fas fa-filter"></i> Generate Report</button>
        <a href="{% url 'violations:staff_reports' %}" class="ghost-btn">Clear</a>
      </form>
    </section>

    <!-- Summary Stats -->
    <section class="dashboard-grid" style="margin-bottom:20px;">
      <div class="dash-card">
        <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="card-title">Total Violations</div>
        <div class="card-metric">{{ total_violations }}</div>
      </div>
      <div class="dash-card">
        <div class="card-icon"><i class="fas fa-balance-scale"></i></div>
        <div class="card-title">By Type</div>
        <div style="display:flex; gap:16px; margin-top:8px;">
          <div>
            <span class="badge badge-danger">Major: {{ by_type.major|default:0 }}</span>
          </div>
          <div>
            <span class="badge badge-warning">Minor: {{ by_type.minor|default:0 }}</span>
          </div>
        </div>
      </div>
      <div class="dash-card">
        <div class="card-icon"><i class="fas fa-tasks"></i></div>
        <div class="card-title">By Status</div>
        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">
          <span class="badge badge-info">Reported: {{ by_status.reported|default:0 }}</span>
          <span class="badge badge-warning">Review: {{ by_status.under_review|default:0 }}</span>
          <span class="badge badge-success">Resolved: {{ by_status.resolved|default:0 }}</span>
          <span class="badge badge-secondary">Dismissed: {{ by_status.dismissed|default:0 }}</span>
        </div>
      </div>
    </section>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
      <!-- Top Offenders -->
      <section class="card">
        <h3 style="margin:0 0 16px;"><i class="fas fa-users"></i> Top Offenders</h3>
        {% if top_offenders %}
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Student</th>
                <th>Violations</th>
              </tr>
            </thead>
            <tbody>
              {% for o in top_offenders %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>
                  <a href="{% url 'violations:staff_student_detail' o.student__student_id %}" style="color:var(--chmsu-dark-green);">
                    {{ o.student__user__first_name }} {{ o.student__user__last_name }}
                  </a>
                  <div style="font-size:12px; color:#667085;">{{ o.student__student_id }}</div>
                </td>
                <td><span class="badge badge-danger">{{ o.count }}</span></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p style="color:#667085; text-align:center;">No data available.</p>
        {% endif %}
      </section>

      <!-- Monthly Trend -->
      <section class="card">
        <h3 style="margin:0 0 16px;"><i class="fas fa-chart-line"></i> Monthly Trend</h3>
        {% if monthly_trend %}
        <div style="max-height:300px; overflow:auto;">
          {% for item in monthly_trend %}
          <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #e5e7eb;">
            <span>{{ item.month }}</span>
            <span class="badge badge-info">{{ item.count }} violations</span>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p style="color:#667085; text-align:center;">No data available.</p>
        {% endif %}
      </section>
    </div>

    <!-- Recent Violations -->
    <section class="card">
      <h3 style="margin:0 0 16px;"><i class="fas fa-list"></i> Recent Violations (Last 50)</h3>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Student</th>
              <th>Description</th>
              <th>Type</th>
              <th>Status</th>
              <th>Incident Date</th>
            </tr>
          </thead>
          <tbody>
            {% for v in violations %}
            <tr>
              <td>
                <a href="{% url 'violations:staff_violation_detail' v.id %}" style="color:var(--chmsu-dark-green);">
                  #{{ v.id }}
                </a>
              </td>
              <td>
                {{ v.student.user.get_full_name|default:v.student.student_id }}
                <div style="font-size:12px; color:#667085;">{{ v.student.student_id }}</div>
              </td>
              <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                {{ v.description|truncatewords:10 }}
              </td>
              <td>
                <span class="badge {% if v.type == 'major' %}badge-danger{% else %}badge-warning{% endif %}">
                  {{ v.type|upper }}
                </span>
              </td>
              <td>
                <span class="badge 
                  {% if v.status == 'reported' %}badge-info
                  {% elif v.status == 'under_review' %}badge-warning
                  {% elif v.status == 'resolved' %}badge-success
                  {% else %}badge-secondary{% endif %}">
                  {{ v.get_status_display }}
                </span>
              </td>
              <td>{{ v.incident_at|date:"M d, Y" }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" style="text-align:center; color:#667085;">No violations found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script src="{% static 'violations/js/script.js' %}"></script>
  <style>
    .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-danger { background: #fee2e2; color: #dc2626; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-success { background: #d1fae5; color: #059669; }
    .badge-info { background: #dbeafe; color: #2563eb; }
    .badge-secondary { background: #f3f4f6; color: #6b7280; }
  </style>
</body>
</html>
