{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% if edit_mode %}Edit{% else %}Create{% endif %} Violation - OSA Staff</title>
  <link rel="stylesheet" href="{% static 'violations/css/style.css' %}" />
  <link rel="stylesheet" href="{% static 'violations/css/main.css' %}" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="icon" type="image/png" href="{% static 'violations/images/chmsu_favicon_round.png' %}" />
</head>
<body class="role-staff">
  <header class="top-nav">
    <div class="top-left">
      <a href="{% url 'violations:staff_dashboard' %}" style="display:flex; align-items:center; gap:12px; text-decoration:none; color:inherit;">
        <img src="{% static 'violations/images/chmsu_logo.png' %}" class="header-logo" alt="CHMSU" />
        <span class="header-title">{% if edit_mode %}Edit{% else %}Encode{% endif %} Violation</span>
      </a>
    </div>
    <div class="top-right">
      <a href="{% url 'violations:staff_violations_list' %}" class="ghost-btn" style="background-color: orange;"><i class="fas fa-arrow-left"></i> Back to List</a>
    </div>
  </header>

  <div class="background-overlay"></div>
  <div class="background-image"></div>

  <main class="container" style="position:relative; z-index:3; margin-top: calc(var(--header-height) + 24px); padding-bottom: 40px;">
    <section class="official-form-card">
      <!-- Form Header -->
      <div class="form-header">
        <div class="form-header-logo">
          <img src="{% static 'violations/images/chmsu_logo.png' %}" alt="CHMSU Logo">
        </div>
        <div class="form-header-text">
          <h1>Carlos Hilado Memorial State University</h1>
          <h2>Office of Student Affairs</h2>
          <h3>{% if edit_mode %}Violation Record Amendment Form{% else %}Student Violation Report Form{% endif %}</h3>
        </div>
        <div class="form-header-meta">
          {% if edit_mode %}
          <span class="form-ref">Record No: <strong>{{ violation.id }}</strong></span>
          {% endif %}
          <span class="form-date">Date Filed: <strong>{% now "F d, Y" %}</strong></span>
        </div>
      </div>

      <form method="post" enctype="multipart/form-data" class="official-form">
        {% csrf_token %}

        <!-- Section A: Student Information -->
        <fieldset class="form-section">
          <legend><i class="fas fa-user-graduate"></i> Section A: Student Information</legend>
          
          {% if not edit_mode %}
          <div class="form-row">
            <div class="form-field full-width">
              <label class="field-label">Student ID Number <span class="required">*</span></label>
              <div class="student-id-input-wrapper">
                <input type="text" id="student_id_input" name="student_id" list="studentList" required 
                       placeholder="Enter 8-digit Student ID (e.g., 20240001)" 
                       pattern="\d{8}"
                       maxlength="8"
                       minlength="8"
                       inputmode="numeric"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 8)"
                       class="form-input">
                <button type="button" id="checkStudentBtn" class="check-student-btn" onclick="checkStudent()">
                  <i class="fas fa-search"></i> Verify
                </button>
              </div>
              <datalist id="studentList">
                {% for s in students %}
                <option value="{{ s.student_id }}">{{ s.user.get_full_name|default:s.student_id }} - {{ s.program|default:'N/A' }}</option>
                {% endfor %}
              </datalist>
              <span class="field-hint"><i class="fas fa-info-circle"></i> Enter 8-digit Student ID (numbers only) and click Verify</span>
              
              <!-- Student Status Indicator -->
              <div id="studentStatusIndicator" class="student-status-indicator" style="display: none;">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- New Student Registration Fields (shown when student not found) -->
          <div id="newStudentFields" class="new-student-fields" style="display: none;">
            <div class="new-student-notice">
              <i class="fas fa-user-plus"></i>
              <span>Student not found in database. Please provide the following information to register:</span>
            </div>
            
            <div class="form-row">
              <div class="form-field" style="flex:1;">
                <label class="field-label">First Name <span class="required">*</span></label>
                <input type="text" id="student_first_name" name="first_name" 
                       placeholder="Enter first name"
                       class="form-input">
              </div>
              <div class="form-field" style="flex:1;">
                <label class="field-label">Last Name <span class="required">*</span></label>
                <input type="text" id="student_last_name" name="last_name" 
                       placeholder="Enter last name"
                       class="form-input">
              </div>
              <div class="form-field" style="flex:0 0 100px;">
                <label class="field-label">Suffix <span style="color:#667085; font-size:10px;">(Optional)</span></label>
                <input type="text" id="student_suffix" name="suffix" 
                       placeholder="Jr., Sr."
                       class="form-input">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-field">
                <label class="field-label">Email</label>
                <input type="email" id="student_email" name="email" 
                       placeholder="student@email.com"
                       class="form-input">
              </div>
              <div class="form-field">
                <label class="field-label">Contact Number</label>
                <input type="text" id="student_contact" name="contact_number" 
                       placeholder="09xxxxxxxxx"
                       pattern="\d{11}" maxlength="11" minlength="11"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11)"
                       class="form-input">
                <span class="field-hint" style="font-size:10px;"><i class="fas fa-info-circle"></i> 11-digit phone number</span>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-field">
                <label class="field-label">College/Program <span class="required">*</span></label>
                <select id="student_program" name="program" class="form-input form-select">
                  <option value="">— Select College —</option>
                  <option value="CAS">CAS - College of Arts and Sciences</option>
                  <option value="CBMA">CBMA - College of Business Management and Accountancy</option>
                  <option value="CCS">CCS - College of Computer Studies</option>
                  <option value="COEd">COEd - College of Education</option>
                  <option value="CIT">CIT - College of Industrial Technology</option>
                  <option value="COE">COE - College of Engineering</option>
                </select>
              </div>
              <div class="form-field">
                <label class="field-label">Year Level <span class="required">*</span></label>
                <select id="student_year_level" name="year_level" class="form-input form-select">
                  <option value="">— Select Year —</option>
                  <option value="1">1st Year</option>
                  <option value="2">2nd Year</option>
                  <option value="3">3rd Year</option>
                  <option value="4">4th Year</option>
                </select>
                <span class="field-hint" style="font-size:10px;"><i class="fas fa-info-circle"></i> Auto-promotes after 10 months</span>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-field">
                <label class="field-label">Guardian Name</label>
                <input type="text" id="student_guardian_name" name="guardian_name" 
                       placeholder="Parent/Guardian name"
                       class="form-input">
              </div>
              <div class="form-field">
                <label class="field-label">Guardian Contact</label>
                <input type="text" id="student_guardian_contact" name="guardian_contact" 
                       placeholder="09xxxxxxxxx"
                       pattern="\d{11}" maxlength="11" minlength="11"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11)"
                       class="form-input">
                <span class="field-hint" style="font-size:10px;"><i class="fas fa-info-circle"></i> 11-digit phone number</span>
              </div>
            </div>
            
            <div class="new-student-note">
              <i class="fas fa-info-circle"></i>
              <span>A student account will be created with the Student ID as the default password.</span>
            </div>
          </div>
          {% else %}
          <div class="form-row">
            <div class="form-field">
              <label class="field-label">Student ID Number</label>
              <div class="readonly-field">{{ violation.student.student_id }}</div>
            </div>
            <div class="form-field">
              <label class="field-label">Student Name</label>
              <div class="readonly-field">{{ violation.student.user.get_full_name|default:"—" }}</div>
            </div>
          </div>
          {% endif %}
        </fieldset>

        <!-- Section B: Incident Details -->
        <fieldset class="form-section">
          <legend><i class="fas fa-clipboard-list"></i> Section B: Incident Details</legend>
          
          <div class="form-row">
            <div class="form-field">
              <label class="field-label">Date of Incident <span class="required">*</span></label>
              <input type="date" name="incident_date" required
                     value="{% if edit_mode %}{{ violation.incident_at|date:'Y-m-d' }}{% endif %}"
                     class="form-input">
            </div>
            <div class="form-field">
              <label class="field-label">Time of Incident</label>
              <input type="time" name="incident_time"
                     value="{% if edit_mode %}{{ violation.incident_at|time:'H:i' }}{% endif %}"
                     class="form-input">
              <span class="field-hint">Optional - specify if known</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label class="field-label">Specific Violation <span class="required">*</span></label>
              <div class="input-with-clear">
                <select name="violation_type_id" id="violation-type" class="form-input form-select">
                  <option value="" disabled {% if not edit_mode or not violation.violation_type %}selected{% endif %}>— Select Violation —</option>
                  {% for vt in violation_types %}
                  <option value="{{ vt.id }}" 
                          data-category="{{ vt.category }}"
                          style="color: {% if vt.category == 'major' %}#dc2626{% else %}#d97706{% endif %}; font-weight: 500;"
                          {% if edit_mode and violation.violation_type and violation.violation_type.id == vt.id %}selected{% endif %}>
                    {{ vt.display_name }}
                  </option>
                  {% endfor %}
                </select>
                <button type="button" id="clear-violation-btn" class="clear-field-btn" title="Clear selection" style="display: none;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <span class="field-hint"><i class="fas fa-info-circle"></i> Select from list or use "Other Violation" below</span>
            </div>
            <div class="form-field">
              <label class="field-label">Violation Category</label>
              <div class="input-with-clear">
                <div id="category-display" class="category-display-field" style="padding: 12px 16px; border: 1px solid #d0d5dd; border-radius: 8px; background: #f9fafb; font-family: 'Poppins', sans-serif; font-size: 14px; min-height: 46px; display: flex; align-items: center; flex: 1;">
                  {% if edit_mode and violation.type %}
                    <span style="color: {% if violation.type == 'major' %}#dc2626{% else %}#d97706{% endif %}; font-weight: 600;">
                      <i class="fas fa-{% if violation.type == 'major' %}exclamation-triangle{% else %}exclamation-circle{% endif %}"></i>
                      {% if violation.type == 'major' %}Major Offense{% else %}Minor Offense{% endif %}
                    </span>
                  {% else %}
                    <span style="color: #9ca3af;">Auto-detected from violation</span>
                  {% endif %}
                </div>
                <button type="button" id="clear-category-btn" class="clear-field-btn" title="Clear category" style="display: none;">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <input type="hidden" name="type" id="violation-category" value="{% if edit_mode %}{{ violation.type }}{% endif %}">
              <span class="field-hint"><i class="fas fa-info-circle"></i> Automatically set based on selected violation</span>
            </div>
          </div>

          <!-- Other Violation (if not in list) -->
          <div class="form-row other-violation-section">
            <div class="form-field full-width">
              <label class="field-label">
                <i class="fas fa-edit"></i> Other Violation - Please Specify The Nature of Violation
                <span class="field-hint-inline">(Fill this if violation is not in the list above)</span>
              </label>
              <input type="text" name="other_violation" id="other-violation"
                     value="{% if edit_mode and not violation.violation_type %}{{ violation.description }}{% endif %}"
                     placeholder="Describe the specific nature of the violation..."
                     class="form-input">
            </div>
          </div>
          
          <div class="form-row other-violation-category" id="other-category-row" style="display: none;">
            <div class="form-field full-width">
              <label class="field-label">Category for Other Violation <span class="required">*</span></label>
              <div class="checkbox-group">
                <label class="checkbox-label major-checkbox">
                  <input type="radio" name="other_category" value="major" id="other-major">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text" style="color: #dc2626; font-weight: 600;">
                    <i class="fas fa-exclamation-triangle"></i> Major Offense
                  </span>
                </label>
                <label class="checkbox-label minor-checkbox">
                  <input type="radio" name="other_category" value="minor" id="other-minor">
                  <span class="checkbox-custom"></span>
                  <span class="checkbox-text" style="color: #d97706; font-weight: 600;">
                    <i class="fas fa-exclamation-circle"></i> Minor Offense
                  </span>
                </label>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field full-width">
              <label class="field-label">Location of Incident <span class="required">*</span></label>
              <input type="text" name="location" required
                     value="{% if edit_mode %}{{ violation.location }}{% endif %}"
                     placeholder="e.g., CHMSU, LSAB Room 310"
                     class="form-input">
            </div>
          </div>

          {% if edit_mode %}
          <div class="form-row">
            <div class="form-field">
              <label class="field-label">Case Status</label>
              <select name="status" class="form-input form-select">
                {% for val, label in status_choices %}
                <option value="{{ val }}" {% if violation.status == val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label class="field-label">Originally Reported By</label>
              <div class="readonly-field">{% if violation.reported_by %}{{ violation.reported_by.get_full_name|default:violation.reported_by.username }}{% else %}—{% endif %}</div>
            </div>
          </div>
          {% endif %}
        </fieldset>

        <!-- Section C: Violation Description -->
        <fieldset class="form-section" id="section-detailed-description">
          <legend><i class="fas fa-file-alt"></i> Section C: Detailed Description</legend>
          
          <div class="form-row">
            <div class="form-field full-width">
              <label class="field-label">Nature of Violation / Incident Narrative <span class="required">*</span></label>
              <textarea name="description" required rows="6" 
                        placeholder="Provide a detailed and objective account of the incident. Include:&#10;• Specific behavior or action observed&#10;• Persons involved or witnesses present&#10;• Circumstances leading to the incident&#10;• Any immediate actions taken"
                        class="form-input form-textarea">{% if edit_mode %}{{ violation.description }}{% endif %}</textarea>
              <span class="field-hint"><i class="fas fa-info-circle"></i> Please provide complete and accurate information for proper assessment</span>
            </div>
          </div>
        </fieldset>

        {% if edit_mode and existing_docs %}
        <!-- Section D: Attached Documents -->
        <fieldset class="form-section">
          <legend><i class="fas fa-folder-open"></i> Section D: Supporting Documents</legend>
          
          <div class="documents-grid">
            {% for doc in existing_docs %}
            <div class="document-item">
              <div class="document-icon">
                <i class="fas fa-file-{% if '.pdf' in doc.document.name %}pdf{% elif '.doc' in doc.document.name %}word{% elif '.jpg' in doc.document.name or '.png' in doc.document.name or '.jpeg' in doc.document.name %}image{% else %}alt{% endif %}"></i>
              </div>
              <div class="document-info">
                <a href="{{ doc.document.url }}" target="_blank" class="document-name">{{ doc.document.name|slice:"-25:" }}</a>
                <span class="document-status {% if doc.is_verified %}verified{% else %}pending{% endif %}">
                  <i class="fas fa-{% if doc.is_verified %}check-circle{% else %}clock{% endif %}"></i>
                  {{ doc.is_verified|yesno:'Verified,Pending Review' }}
                </span>
              </div>
            </div>
            {% endfor %}
          </div>
        </fieldset>
        {% endif %}

        <!-- Form Actions -->
        <div class="form-actions">
          <div class="form-notice">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Fields marked with <span class="required">*</span> are mandatory. Please ensure all information provided is accurate and complete.</span>
          </div>
          <div class="action-buttons">
            <a href="{% url 'violations:staff_violations_list' %}" class="btn btn-secondary">
              <i class="fas fa-times"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-{% if edit_mode %}check{% else %}paper-plane{% endif %}"></i> 
              {% if edit_mode %}Update Record{% else %}Submit Report{% endif %}
            </button>
          </div>
        </div>
      </form>

      <!-- Form Footer -->
      <div class="form-footer">
        <p>This is an official document of the Office of Student Affairs. Unauthorized modification is strictly prohibited.</p>
        <p class="form-footer-meta">Form Version 2.0 | CHMSU-OSA-VRF</p>
      </div>
    </section>
  </main>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const categoryInput = document.getElementById('violation-category');
  const categoryDisplay = document.getElementById('category-display');
  const violationSelect = document.getElementById('violation-type');
  const otherViolationInput = document.getElementById('other-violation');
  const otherCategoryRow = document.getElementById('other-category-row');
  const otherMajorRadio = document.getElementById('other-major');
  const otherMinorRadio = document.getElementById('other-minor');
  const form = document.querySelector('.official-form');
  const clearViolationBtn = document.getElementById('clear-violation-btn');
  const clearCategoryBtn = document.getElementById('clear-category-btn');
  
  // Student verification tracking
  let studentVerified = false;
  let studentExists = false;
  
  // Function to update category display based on selected violation
  function updateCategoryDisplay(category) {
    if (category === 'major') {
      categoryDisplay.innerHTML = `
        <span style="color: #dc2626; font-weight: 600;">
          <i class="fas fa-exclamation-triangle"></i> Major Offense
        </span>
      `;
      categoryInput.value = 'major';
      clearCategoryBtn.style.display = 'flex';
    } else if (category === 'minor') {
      categoryDisplay.innerHTML = `
        <span style="color: #d97706; font-weight: 600;">
          <i class="fas fa-exclamation-circle"></i> Minor Offense
        </span>
      `;
      categoryInput.value = 'minor';
      clearCategoryBtn.style.display = 'flex';
    } else {
      categoryDisplay.innerHTML = `<span style="color: #9ca3af;">Auto-detected from violation</span>`;
      categoryInput.value = '';
      clearCategoryBtn.style.display = 'none';
    }
  }
  
  // Function to update clear button visibility for violation select
  function updateClearButtonVisibility() {
    if (violationSelect.value !== '') {
      clearViolationBtn.style.display = 'flex';
    } else {
      clearViolationBtn.style.display = 'none';
    }
  }
  
  // Function to reset/clear violation selection
  function clearViolationSelection() {
    violationSelect.selectedIndex = 0; // Reset to placeholder
    updateCategoryDisplay(null);
    updateClearButtonVisibility();
    // Focus on other violation field for convenience
    otherViolationInput.focus();
  }
  
  // Clear violation button click handler
  clearViolationBtn.addEventListener('click', clearViolationSelection);
  
  // Clear category button click handler (also clears violation)
  clearCategoryBtn.addEventListener('click', clearViolationSelection);
  
  // Check if student exists in database
  window.checkStudent = function() {
    const studentIdInput = document.getElementById('student_id_input');
    const studentId = studentIdInput.value.trim();
    const statusIndicator = document.getElementById('studentStatusIndicator');
    const newStudentFields = document.getElementById('newStudentFields');
    const checkBtn = document.getElementById('checkStudentBtn');
    
    if (!studentId) {
      alert('Please enter a Student ID first.');
      return;
    }
    
    // Show loading state
    checkBtn.disabled = true;
    checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    
    fetch(`{% url 'violations:staff_check_student' %}?student_id=${encodeURIComponent(studentId)}`)
      .then(response => response.json())
      .then(data => {
        studentVerified = true;
        
        if (data.exists) {
          // Student found
          studentExists = true;
          newStudentFields.style.display = 'none';
          statusIndicator.style.display = 'block';
          statusIndicator.className = 'student-status-indicator status-found';
          statusIndicator.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <div class="status-details">
              <span class="status-title">Student Found</span>
              <span class="status-info">${data.student_name}</span>
              <span class="status-sub">${data.program || 'N/A'} • Year ${data.year_level || 'N/A'}</span>
            </div>
          `;
        } else {
          // Student not found - show registration fields
          studentExists = false;
          newStudentFields.style.display = 'block';
          statusIndicator.style.display = 'block';
          statusIndicator.className = 'student-status-indicator status-not-found';
          statusIndicator.innerHTML = `
            <i class="fas fa-user-plus"></i>
            <div class="status-details">
              <span class="status-title">New Student</span>
              <span class="status-info">Not registered in the system</span>
              <span class="status-sub">Please fill in the details below to register</span>
            </div>
          `;
          // Focus on first name field
          document.getElementById('student_first_name').focus();
        }
      })
      .catch(err => {
        console.error('Error checking student:', err);
        statusIndicator.style.display = 'block';
        statusIndicator.className = 'student-status-indicator status-error';
        statusIndicator.innerHTML = `
          <i class="fas fa-exclamation-circle"></i>
          <div class="status-details">
            <span class="status-title">Error</span>
            <span class="status-info">Could not verify student</span>
          </div>
        `;
      })
      .finally(() => {
        checkBtn.disabled = false;
        checkBtn.innerHTML = '<i class="fas fa-search"></i> Verify';
      });
  };

  // Auto-check when student ID changes (with debounce) - only in create mode
  {% if not edit_mode %}
  let checkTimeout;
  const studentIdInput = document.getElementById('student_id_input');
  if (studentIdInput) {
    studentIdInput.addEventListener('input', function() {
      studentVerified = false;
      studentExists = false;
      const newStudentFields = document.getElementById('newStudentFields');
      const statusIndicator = document.getElementById('studentStatusIndicator');
      if (newStudentFields) newStudentFields.style.display = 'none';
      if (statusIndicator) statusIndicator.style.display = 'none';
      
      // Clear previous timeout
      clearTimeout(checkTimeout);
      
      // Set new timeout for auto-check (after 800ms of no typing)
      const value = this.value.trim();
      if (value.length >= 5) { // Only check if at least 5 characters
        checkTimeout = setTimeout(window.checkStudent, 800);
      }
    });
  }
  {% endif %}
  
  // Get Section C element
  const sectionDetailedDescription = document.getElementById('section-detailed-description');
  const descriptionTextarea = document.querySelector('textarea[name="description"]');
  
  // Show/hide other category options based on other violation input
  function toggleOtherCategory() {
    if (otherViolationInput.value.trim() !== '') {
      otherCategoryRow.style.display = 'block';
      // Clear the dropdown selection when using other violation
      violationSelect.value = '';
      updateCategoryDisplay(null);
      updateClearButtonVisibility();
      // Hide Section C when using Other Violation
      sectionDetailedDescription.style.display = 'none';
      // Remove required from description when hidden
      if (descriptionTextarea) descriptionTextarea.removeAttribute('required');
    } else {
      otherCategoryRow.style.display = 'none';
      otherMajorRadio.checked = false;
      otherMinorRadio.checked = false;
    }
  }
  
  // Show Section C when using Specific Violation dropdown
  function showSectionC() {
    sectionDetailedDescription.style.display = 'block';
    // Add required back to description
    if (descriptionTextarea) descriptionTextarea.setAttribute('required', 'required');
  }
  
  // Clear other violation when dropdown is used
  function clearOtherViolation() {
    if (violationSelect.value !== '') {
      otherViolationInput.value = '';
      otherCategoryRow.style.display = 'none';
      otherMajorRadio.checked = false;
      otherMinorRadio.checked = false;
      // Show Section C when using Specific Violation
      showSectionC();
    }
  }
  
  // Listen for other violation input
  otherViolationInput.addEventListener('input', toggleOtherCategory);
  
  // Listen for other category radio buttons
  otherMajorRadio.addEventListener('change', function() {
    if (this.checked) {
      updateCategoryDisplay('major');
    }
  });
  
  otherMinorRadio.addEventListener('change', function() {
    if (this.checked) {
      updateCategoryDisplay('minor');
    }
  });
  
  // When violation is selected, auto-set the category
  violationSelect.addEventListener('change', function() {
    const selected = violationSelect.options[violationSelect.selectedIndex];
    if (selected && selected.dataset.category) {
      updateCategoryDisplay(selected.dataset.category);
      // Clear other violation when using dropdowns
      clearOtherViolation();
    } else {
      updateCategoryDisplay(null);
    }
    updateClearButtonVisibility();
  });
  
  // Form validation
  form.addEventListener('submit', function(e) {
    const hasViolationSelected = violationSelect.value !== '';
    const hasOtherViolation = otherViolationInput.value.trim() !== '';
    const hasOtherCategory = otherMajorRadio.checked || otherMinorRadio.checked;
    
    {% if not edit_mode %}
    // Check if student verification was done
    if (!studentVerified) {
      e.preventDefault();
      alert('Please click "Verify" to check if the student exists in the database.');
      document.getElementById('checkStudentBtn').focus();
      return false;
    }
    
    // Validation for new student registration
    if (!studentExists) {
      const firstName = document.getElementById('student_first_name').value.trim();
      const lastName = document.getElementById('student_last_name').value.trim();
      
      if (!firstName || !lastName) {
        e.preventDefault();
        alert('Please provide First Name and Last Name to register the new student.');
        if (!firstName) {
          document.getElementById('student_first_name').focus();
        } else {
          document.getElementById('student_last_name').focus();
        }
        return false;
      }
    }
    {% endif %}
    
    // Must have either violation selected OR other violation with category
    if (!hasViolationSelected && !hasOtherViolation) {
      e.preventDefault();
      alert('Please select a Specific Violation OR fill in the Other Violation field.');
      return false;
    }
    
    // If other violation is filled, must have category selected
    if (hasOtherViolation && !hasOtherCategory) {
      e.preventDefault();
      alert('Please select Major or Minor for the Other Violation.');
      return false;
    }
    
    // If using other violation, set the type from radio button
    if (hasOtherViolation && hasOtherCategory) {
      const selectedCategory = otherMajorRadio.checked ? 'major' : 'minor';
      categoryInput.value = selectedCategory;
    }
    
    // If using Specific Violation, check that description is filled
    if (hasViolationSelected && !hasOtherViolation) {
      const description = descriptionTextarea ? descriptionTextarea.value.trim() : '';
      if (!description) {
        e.preventDefault();
        alert('Please provide a detailed description of the incident in Section C.');
        if (descriptionTextarea) descriptionTextarea.focus();
        return false;
      }
    }
    
    return true;
  });
  
  // Initial check for other violation (edit mode)
  toggleOtherCategory();
  
  // Initial setup for edit mode - trigger change event to set category
  {% if edit_mode and violation.violation_type %}
  const initialSelected = violationSelect.options[violationSelect.selectedIndex];
  if (initialSelected && initialSelected.dataset.category) {
    updateCategoryDisplay(initialSelected.dataset.category);
  }
  // Show Section C for specific violation
  showSectionC();
  {% elif edit_mode and violation.type %}
  // If other violation was used (no violation_type but has type)
  updateCategoryDisplay('{{ violation.type }}');
  // Hide Section C for other violation in edit mode
  sectionDetailedDescription.style.display = 'none';
  if (descriptionTextarea) descriptionTextarea.removeAttribute('required');
  {% endif %}
  
  // Initial clear button visibility
  updateClearButtonVisibility();
  
  // Initial Section C visibility based on current state
  if (violationSelect.value !== '') {
    showSectionC();
  } else if (otherViolationInput.value.trim() !== '') {
    sectionDetailedDescription.style.display = 'none';
    if (descriptionTextarea) descriptionTextarea.removeAttribute('required');
  }
});
</script>
  <script src="{% static 'violations/js/script.js' %}"></script>
  <style>
    {% include "violations/staff/partials/official_form_styles.html" %}
    
    /* Student ID Input Wrapper with Verify Button */
    .student-id-input-wrapper {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }
    
    .student-id-input-wrapper .form-input {
      flex: 1;
    }
    
    .check-student-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, #1a472a 0%, #2d6a3f 100%);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .check-student-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(26, 71, 42, 0.3);
    }
    
    .check-student-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Student Status Indicator */
    .student-status-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 10px;
      margin-top: 12px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .student-status-indicator i {
      font-size: 24px;
    }
    
    .student-status-indicator .status-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .student-status-indicator .status-title {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      font-weight: 700;
    }
    
    .student-status-indicator .status-info {
      font-family: 'Poppins', sans-serif;
      font-size: 13px;
      font-weight: 500;
    }
    
    .student-status-indicator .status-sub {
      font-family: 'Poppins', sans-serif;
      font-size: 11px;
      opacity: 0.85;
    }
    
    .student-status-indicator.status-found {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border: 2px solid #059669;
    }
    
    .student-status-indicator.status-found i,
    .student-status-indicator.status-found .status-title {
      color: #059669;
    }
    
    .student-status-indicator.status-found .status-info,
    .student-status-indicator.status-found .status-sub {
      color: #065f46;
    }
    
    .student-status-indicator.status-not-found {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #d97706;
    }
    
    .student-status-indicator.status-not-found i,
    .student-status-indicator.status-not-found .status-title {
      color: #d97706;
    }
    
    .student-status-indicator.status-not-found .status-info,
    .student-status-indicator.status-not-found .status-sub {
      color: #92400e;
    }
    
    .student-status-indicator.status-error {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #dc2626;
    }
    
    .student-status-indicator.status-error i,
    .student-status-indicator.status-error .status-title {
      color: #dc2626;
    }
    
    .student-status-indicator.status-error .status-info {
      color: #991b1b;
    }
    
    /* New Student Registration Fields */
    .new-student-fields {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      animation: fadeIn 0.3s ease;
    }
    
    .new-student-notice {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #ffffff;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #f59e0b;
    }
    
    .new-student-notice i {
      font-size: 20px;
      color: #f59e0b;
    }
    
    .new-student-notice span {
      font-family: 'Poppins', sans-serif;
      font-size: 13px;
      font-weight: 500;
      color: #92400e;
    }
    
    .new-student-note {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #ffffff;
      border-radius: 8px;
      margin-top: 16px;
      border: 1px dashed #d97706;
    }
    
    .new-student-note i {
      color: #d97706;
      font-size: 16px;
    }
    
    .new-student-note span {
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
      color: #92400e;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .student-id-input-wrapper {
        flex-direction: column;
      }
      
      .check-student-btn {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* Input with Clear Button */
    .input-with-clear {
      display: flex;
      align-items: stretch;
      gap: 8px;
      position: relative;
    }
    
    .input-with-clear .form-input,
    .input-with-clear .form-select {
      flex: 1;
    }
    
    .clear-field-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 42px;
      height: 46px;
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 2px solid #fca5a5;
      border-radius: 8px;
      color: #dc2626;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }
    
    .clear-field-btn:hover {
      background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
      border-color: #f87171;
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.25);
    }
    
    .clear-field-btn:active {
      transform: scale(0.98);
    }
    
    .clear-field-btn i {
      font-size: 14px;
    }
  </style>
</body>
</html>
