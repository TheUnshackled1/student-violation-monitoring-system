{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - CHMSU Student Violation Tracker</title>
        <link rel="stylesheet" href="{% static 'violations/css/style.css' %}" />
        <link rel="stylesheet" href="{% static 'violations/css/main.css' %}" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body class="role-student">
    <!-- Top Navigation -->
    <header class="top-nav">
        <div class="top-left">
            <img src="{% static 'violations/images/chmsu_logo.png' %}" class="header-logo" alt="CHMSU" />
            <span class="header-title">Student Dashboard</span>
        </div>
        <div class="top-right">
            <button class="icon-btn" id="notifBtn" aria-label="Notifications" style="position:relative;">
                <i class="fas fa-bell"></i>
                {% if unread_count %}
                <span class="notif-badge" style="position:absolute; top:2px; right:2px; background:#dc2626; color:#fff; font-size:10px; padding:2px 5px; border-radius:10px; line-height:1;">{{ unread_count }}</span>
                {% endif %}
            </button>
            <button class="icon-btn" id="trashBtn" aria-label="Trash" title="Deleted Messages" style="position:relative;">
                <i class="fas fa-trash-alt"></i>
                {% if trashed_messages %}<span class="notif-badge" style="position:absolute; top:2px; right:2px; background:#6b7280; color:#fff; font-size:10px; padding:2px 5px; border-radius:10px; line-height:1;">{{ trashed_messages|length }}</span>{% endif %}
            </button>
            <div class="profile-menu">
                <button class="profile-btn" id="profileBtn">
                    <span class="avatar">{{ request.user.first_name|default:request.user.username|first|upper }}</span>
                    <span class="name">{{ request.user.first_name|default:request.user.username }}</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown" id="profileDropdown">
                    <a href="{% url 'violations:auth_logout' %}">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <div class="background-overlay"></div>
    <div class="background-image"></div>

    <main class="container" style="position:relative; z-index:3; margin-top: calc(var(--header-height) + 24px);">
        <!-- Welcome -->
        <section class="card" style="margin-bottom:16px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
                <div>
                    <h2 style="margin-bottom:4px;">Welcome{% if request.user.first_name %}, {{ request.user.first_name }}{% endif %}!</h2>
                    <p style="color:#667085;">Logged in as <strong>{{ request.user.username }}</strong></p>
                </div>
                <a href="{% url 'violations:auth_logout' %}" class="ghost-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </section>

        <!-- Quick Stats -->
        <section class="dashboard-grid">
            <div class="dash-card">
                <div class="card-icon"><i class="fas fa-list"></i></div>
                <div class="card-title">Total Violations</div>
                <div class="card-metric">{{ violations|length }}</div>
            </div>
            <div class="dash-card">
                <div class="card-icon"><i class="fas fa-triangle-exclamation"></i></div>
                <div class="card-title">Latest Status</div>
                <div class="card-desc">{% if violations and violations.0 %}{{ violations.0.get_status_display }}{% else %}None{% endif %}</div>
            </div>
            <div class="dash-card clickable" id="loginHistoryCard" role="button" tabindex="0" title="View login history">
                <div class="card-icon"><i class="fas fa-right-to-bracket"></i></div>
                <div class="card-title">Logged in History</div>
                <div class="card-desc">{% if request.user.last_login %}{{ request.user.last_login|date:"M d, Y g:i A" }}{% else %}—{% endif %}</div>
            </div>
            <div class="dash-card">
                <div class="card-icon"><i class="fas fa-scale-balanced"></i></div>
                <div class="card-title">Standing</div>
                <div class="card-desc">{% if violations|length %}{{ violations|length }} violation{{ violations|length|pluralize }}{% else %}Good Standing{% endif %}</div>
            </div>
        </section>

        <!-- Two-column layout: Profile + Violations -->
        <section class="grid-2" style="display:grid; grid-template-columns: 1fr 2fr; gap:16px; margin-top:16px;">
            <!-- Profile Card -->
            <aside class="card">
                <h3 style="margin-bottom:12px;">Your Information</h3>
                <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                    {% if student and student.profile_image %}
                        <img src="{{ student.profile_image.url }}" alt="Profile" style="width:64px; height:64px; border-radius:50%; object-fit:cover;" />
                    {% else %}
                        <div style="width:64px; height:64px; border-radius:50%; background:#eef2ff; color:#4f46e5; display:flex; align-items:center; justify-content:center; font-weight:600;">
                            {{ request.user.first_name|default:request.user.username|first|upper }}
                        </div>
                    {% endif %}
                    <div>
                        <div style="font-weight:600;">{{ request.user.get_full_name|default:request.user.username }}</div>
                        <div style="color:#667085; font-size: 0.9rem;">{{ student.program|default:'No program set' }}</div>
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <p><strong>Student ID:</strong> {{ student.student_id|default:'—' }}</p>
                        <p><strong>Year Level:</strong> {{ student.year_level|default:'—' }}</p>
                        <p><strong>Status:</strong> {{ student.enrollment_status|default:'—' }}</p>
                    </div>
                    <div>
                        <p><strong>Department:</strong> {{ student.department|default:'—' }}</p>
                        <p><strong>Contact:</strong> {{ student.contact_number|default:'—' }}</p>
                        <p><strong>Guardian:</strong> {{ student.guardian_name|default:'—' }}</p>
                    </div>
                </div>
            </aside>

            <!-- Violations Table -->
            <section class="card">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <h3>Your Violations</h3>
                    <span class="badge badge-warning">{{ violations|length }} records</span>
                </div>
                {% if violations %}
                <div class="table-responsive" style="margin-top: 10px;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Reported By</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in violations %}
                            {% with latest_apology=v.apology_letters.all|first %}
                            <tr class="violation-row"
                                style="{% if v.status == 'resolved' %}background-color: #dcfce7;{% elif latest_apology.status == 'approved' %}background-color: #dcfce7;{% elif v.status == 'dismissed' %}background-color: #f3f4f6;{% elif v.status == 'reported' or v.status == 'under_review' %}background-color: #fee2e2;{% endif %}"
                                data-id="{{ v.id }}"
                                data-type="{{ v.get_type_display }}"
                                data-type-raw="{{ v.type }}"
                                data-status="{{ v.get_status_display }}"
                                data-status-raw="{{ v.status }}"
                                data-apology-status="{% if latest_apology %}{{ latest_apology.status }}{% endif %}"
                                data-date="{{ v.created_at|date:'M d, Y' }}"
                                data-incident-date="{{ v.incident_at|date:'M d, Y g:i A' }}"
                                data-location="{{ v.location }}"
                                data-description="{{ v.description }}"
                                data-reporter="{{ v.reporter.get_full_name|default:v.reporter.username }}"
                                data-witness="{{ v.witness_statement|default:'' }}"
                                data-evidence="{% if v.evidence_file %}{{ v.evidence_file.url }}{% endif %}">
                                <td>{{ v.created_at|date:"M d, Y" }}</td>
                                <td>
                                    {% if v.type == 'major' %}
                                        <span class="badge" style="background:#fee2e2; color:#b91c1c;">{{ v.get_type_display }}</span>
                                    {% else %}
                                        <span class="badge" style="background:#e0e7ff; color:#3730a3;">{{ v.get_type_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if v.status == 'resolved' %}
                                        <span class="badge" style="background:#dcfce7; color:#166534;"><i class="fas fa-check-circle"></i> Resolved</span>
                                    {% elif v.status == 'dismissed' %}
                                        <span class="badge" style="background:#f3f4f6; color:#374151;"><i class="fas fa-ban"></i> Dismissed</span>
                                    {% elif latest_apology %}
                                        {% if latest_apology.status == 'approved' %}
                                            <span class="badge" style="background:#dcfce7; color:#166534;"><i class="fas fa-check-circle"></i> Letter Approved</span>
                                        {% elif latest_apology.status == 'pending' %}
                                            <span class="badge" style="background:#fef9c3; color:#854d0e;"><i class="fas fa-clock"></i> Letter Pending</span>
                                        {% elif latest_apology.status == 'revision_needed' %}
                                            <span class="badge" style="background:#fff7ed; color:#9a3412;"><i class="fas fa-edit"></i> Revision Needed</span>
                                        {% elif latest_apology.status == 'rejected' %}
                                            <span class="badge" style="background:#fee2e2; color:#b91c1c;"><i class="fas fa-times-circle"></i> Letter Rejected</span>
                                        {% endif %}
                                    {% elif v.status == 'reported' %}
                                        <span class="badge" style="background:#fee2e2; color:#b91c1c;"><i class="fas fa-exclamation-circle"></i> Pending</span>
                                    {% elif v.status == 'under_review' %}
                                        <span class="badge" style="background:#fef9c3; color:#854d0e;"><i class="fas fa-search"></i> Under Review</span>
                                    {% else %}
                                        <span class="badge" style="background:#f3f4f6; color:#374151;">{{ v.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ v.reporter.get_full_name|default:v.reporter.username }}</td>
                                <td>
                                    <button class="view-violation-btn" style="background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-size:12px;">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endwith %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p style="color:#555; margin-top:8px;">No violations found. Keep up the good conduct!</p>
                {% endif %}
            </section>
        </section>
    </main>

    <!-- Notifications Panel -->
    <aside class="notif-panel" id="notifPanel" aria-hidden="true">
        <div class="notif-header">
            <h3>Messages {% if unread_count %}<span class="badge badge-danger" style="font-size:12px; margin-left:6px;">{{ unread_count }} new</span>{% endif %}</h3>
            <button class="icon-btn" id="notifClose"><i class="fas fa-times"></i></button>
        </div>
        <ul class="notif-list" style="max-height:400px; overflow-y:auto; padding:0; margin:0;">
            {% if staff_messages %}
                {% for msg in staff_messages %}
                <li class="message-item {% if not msg.read_at %}unread{% endif %}" 
                    data-message-id="{{ msg.id }}"
                    data-sender-id="{{ msg.sender.id }}"
                    data-sender="{{ msg.sender.get_full_name|default:msg.sender.username }}"
                    data-date="{{ msg.created_at|date:'M d, Y H:i' }}"
                    data-content="{{ msg.content }}"
                    style="padding:12px; border-bottom:1px solid #eee; cursor:pointer; {% if not msg.read_at %}background:#f0fdf4;{% endif %}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px;">
                        <strong style="color:var(--chmsu-dark-green);">
                            <i class="fas fa-user-tie"></i> {{ msg.sender.get_full_name|default:msg.sender.username }}
                        </strong>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <small style="color:#667085;">{{ msg.created_at|date:"M d, g:i A" }}</small>
                            <button class="delete-msg-btn" data-msg-id="{{ msg.id }}" title="Move to Trash" 
                                    onclick="event.stopPropagation();"
                                    style="background:none; border:none; color:#ef4444; cursor:pointer; padding:2px; font-size:12px;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <p style="margin:0; color:#344054; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ msg.content|truncatechars:50 }}</p>
                    {% if not msg.read_at %}
                    <span class="unread-dot" style="display:inline-block; width:8px; height:8px; background:#dc2626; border-radius:50%; margin-top:6px;"></span>
                    {% endif %}
                </li>
                {% endfor %}
            {% else %}
                <li style="padding:12px; color:#667085; text-align:center;">
                    <i class="fas fa-inbox"></i> No messages yet.
                </li>
            {% endif %}
        </ul>
    </aside>

    <!-- Trash Panel -->
    <aside class="notif-panel" id="trashPanel" aria-hidden="true">
        <div class="notif-header">
            <h3><i class="fas fa-trash-alt"></i> Deleted Messages</h3>
            <button class="icon-btn" id="trashClose"><i class="fas fa-times"></i></button>
        </div>
        <ul class="notif-list" style="max-height:400px; overflow-y:auto; padding:0; margin:0;">
            {% if trashed_messages %}
                {% for msg in trashed_messages %}
                <li class="trash-item" data-message-id="{{ msg.id }}" 
                    style="padding:12px; border-bottom:1px solid #eee; opacity:0.8;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px;">
                        <div>
                            {% if msg.sender == request.user %}
                            <span class="badge" style="background:#e5e7eb; color:#374151; font-size:10px; margin-right:4px;">Sent</span>
                            <strong style="color:#6b7280;">
                                <i class="fas fa-user-tie"></i> {{ msg.receiver.get_full_name|default:msg.receiver.username }}
                            </strong>
                            {% else %}
                            <span class="badge" style="background:#dbeafe; color:#1e40af; font-size:10px; margin-right:4px;">Received</span>
                            <strong style="color:#6b7280;">
                                <i class="fas fa-user-tie"></i> {{ msg.sender.get_full_name|default:msg.sender.username }}
                            </strong>
                            {% endif %}
                        </div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <small style="color:#9ca3af;">{{ msg.created_at|date:"M d, g:i A" }}</small>
                            <button class="restore-msg-btn" data-msg-id="{{ msg.id }}" title="Restore Message" 
                                    style="background:none; border:none; color:#10b981; cursor:pointer; padding:2px; font-size:12px;">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>
                    <p style="margin:0; color:#9ca3af; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ msg.content|truncatechars:50 }}</p>
                </li>
                {% endfor %}
            {% else %}
                <li style="padding:20px; color:#667085; text-align:center;">
                    <i class="fas fa-trash" style="font-size:24px; margin-bottom:8px; display:block; color:#d1d5db;"></i>
                    No deleted messages.
                </li>
            {% endif %}
        </ul>
    </aside>

    <!-- Message View Modal -->
    <div class="modal" id="messageViewModal" aria-hidden="true">
        <div class="modal-card" style="max-width:500px;">
            <div class="modal-header">
                <h3><i class="fas fa-envelope-open"></i> Message</h3>
                <button class="icon-btn" id="msgViewClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #eee;">
                    <div>
                        <strong style="color:var(--chmsu-dark-green); font-size:16px;">
                            <i class="fas fa-user-tie"></i> <span id="msgViewSender">—</span>
                        </strong>
                        <div style="color:#667085; font-size:13px; margin-top:4px;">OSA Staff</div>
                    </div>
                    <small style="color:#667085;" id="msgViewDate">—</small>
                </div>
                <div id="msgViewContent" style="color:#344054; line-height:1.6; white-space:pre-wrap;">
                    —
                </div>
                
                <!-- Reply Section -->
                <div id="replySection" style="margin-top:16px; padding-top:16px; border-top:1px solid #eee;">
                    <label for="replyInput" style="font-weight:600; color:#344054; margin-bottom:8px; display:block;">
                        <i class="fas fa-reply"></i> Reply to Staff
                    </label>
                    <div style="position:relative;">
                        <textarea id="replyInput" maxlength="10" placeholder="Type your reply (max 10 characters)..." 
                            style="width:100%; padding:10px; border:1px solid #d0d5dd; border-radius:8px; resize:none; font-family:inherit; font-size:14px; height:60px;"></textarea>
                        <small id="replyCharCount" style="position:absolute; bottom:8px; right:10px; color:#667085; font-size:11px;">0/10</small>
                    </div>
                    <button id="sendReplyBtn" class="login-button" style="margin-top:10px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" disabled>
                        <i class="fas fa-paper-plane"></i> Send Reply
                    </button>
                </div>
            </div>
            <div class="modal-actions" style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="login-button" id="msgViewMarkRead" style="display:none; background:linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fas fa-check"></i> Mark as Read
                </button>
                <button class="login-button" id="msgViewCloseBtn" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Login History Modal -->
    <div class="modal" id="loginHistoryModal" aria-hidden="true">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Logged in History</h3>
                <button class="icon-btn" id="loginHistClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <p><strong>Last login:</strong> {% if request.user.last_login %}{{ request.user.last_login|date:"M d, Y g:i A" }}{% else %}—{% endif %}</p>
                <p><strong>Account created:</strong> {{ request.user.date_joined|date:"M d, Y g:i A" }}</p>
                <div style="margin-top:10px;">
                    <h4 style="margin:6px 0 8px;">Your Login History</h4>
                    {% if login_history %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="min-width:140px;">Time</th>
                                        <th>Event</th>
                                        <th>IP</th>
                                        <th>User Agent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in login_history %}
                                    <tr>
                                        <td>{{ entry.timestamp|date:"M d, Y g:i A" }}</td>
                                        <td>{{ entry.get_event_type_display }}</td>
                                        <td>{{ entry.ip_address|default:'—' }}</td>
                                        <td style="max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ entry.user_agent|default:'—' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p style="color:#667085;">No login events recorded yet.</p>
                    {% endif %}
                </div>
            </div>
            <div class="modal-actions">
                <button class="login-button" id="loginHistCloseBtn" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Violation Details Modal -->
    <div class="modal" id="violationModal" aria-hidden="true">
        <div class="modal-card" style="max-width:600px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Violation Details</h3>
                <button class="icon-btn" id="violationModalClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <!-- Type and Status badges -->
                <div style="display:flex; gap:12px; margin-bottom:16px;">
                    <span id="violationTypeBadge" class="badge" style="padding:6px 12px; font-size:13px;"></span>
                    <span id="violationStatusBadge" class="badge" style="padding:6px 12px; font-size:13px;"></span>
                </div>
                
                <!-- Violation Info Grid -->
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:12px; color:#667085; display:block; margin-bottom:4px;">Incident Date</label>
                        <p id="violationIncidentDate" style="font-weight:500; margin:0;">—</p>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#667085; display:block; margin-bottom:4px;">Reported On</label>
                        <p id="violationReportedDate" style="font-weight:500; margin:0;">—</p>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#667085; display:block; margin-bottom:4px;">Reported By</label>
                        <p id="violationReporter" style="font-weight:500; margin:0;">—</p>
                    </div>
                    <div>
                        <label style="font-size:12px; color:#667085; display:block; margin-bottom:4px;">Location</label>
                        <p id="violationLocation" style="font-weight:500; margin:0;">—</p>
                    </div>
                </div>
                
                <!-- Description -->
                <div style="margin-bottom:16px;">
                    <label style="font-size:12px; color:#667085; display:block; margin-bottom:4px;">Description</label>
                    <div id="violationDescription" style="background:#f9fafb; padding:12px; border-radius:8px; line-height:1.6; white-space:pre-wrap;">—</div>
                </div>
                
                <!-- Witness Statement (if any) -->
                <div id="witnessSection" style="margin-bottom:16px; display:none;">
                    <label style="font-size:12px; color:#667085; display:block; margin-bottom:4px;">Witness Statement</label>
                    <div id="violationWitness" style="background:#fef3c7; padding:12px; border-radius:8px; line-height:1.6; white-space:pre-wrap;">—</div>
                </div>
                
                <!-- Evidence (if any) -->
                <div id="evidenceSection" style="display:none;">
                    <label style="font-size:12px; color:#667085; display:block; margin-bottom:4px;">Evidence</label>
                    <a id="violationEvidence" href="#" target="_blank" style="display:inline-flex; align-items:center; gap:6px; color:#3b82f6; text-decoration:none;">
                        <i class="fas fa-file-alt"></i> <span>View Evidence File</span>
                    </a>
                </div>
            </div>
            <div class="modal-actions" style="display:flex; gap:10px; justify-content:flex-end;">
                <a href="{% url 'violations:student_apology' %}" class="login-button" id="writeApologyBtn" style="background:linear-gradient(135deg, #10b981 0%, #059669 100%); text-decoration:none;">
                    <i class="fas fa-pen-to-square"></i> Write Apology Letter
                </a>
                <button class="login-button" id="violationModalCloseBtn" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <script src="{% static 'violations/js/script.js' %}"></script>
    <script>
        // Message View Modal functionality
        (function(){
            const modal = document.getElementById('messageViewModal');
            const closeBtn = document.getElementById('msgViewClose');
            const closeBtnFooter = document.getElementById('msgViewCloseBtn');
            const markReadBtn = document.getElementById('msgViewMarkRead');
            const senderEl = document.getElementById('msgViewSender');
            const dateEl = document.getElementById('msgViewDate');
            const contentEl = document.getElementById('msgViewContent');
            
            // Reply elements
            const replyInput = document.getElementById('replyInput');
            const replyCharCount = document.getElementById('replyCharCount');
            const sendReplyBtn = document.getElementById('sendReplyBtn');
            
            let currentMsgId = null;
            let currentListItem = null;
            let currentSenderId = null;

            // Character count for reply
            if(replyInput){
                replyInput.addEventListener('input', function(){
                    const len = this.value.length;
                    replyCharCount.textContent = len + '/10';
                    sendReplyBtn.disabled = len === 0;
                    
                    // Visual feedback when approaching limit
                    if(len >= 8){
                        replyCharCount.style.color = '#dc2626';
                    } else {
                        replyCharCount.style.color = '#667085';
                    }
                });
            }

            // Send reply handler
            if(sendReplyBtn){
                sendReplyBtn.addEventListener('click', function(){
                    const replyText = replyInput.value.trim();
                    if(!replyText || !currentMsgId) return;
                    
                    sendReplyBtn.disabled = true;
                    sendReplyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                    
                    fetch('{% url "violations:student_reply_message" %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message_id: currentMsgId,
                            reply: replyText
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.status === 'ok'){
                            // Clear input and show success
                            replyInput.value = '';
                            replyCharCount.textContent = '0/10';
                            sendReplyBtn.innerHTML = '<i class="fas fa-check"></i> Sent!';
                            sendReplyBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                            
                            setTimeout(() => {
                                sendReplyBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reply';
                                sendReplyBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                                sendReplyBtn.disabled = true;
                            }, 2000);
                        } else {
                            alert(data.error || 'Failed to send reply');
                            sendReplyBtn.disabled = false;
                            sendReplyBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reply';
                        }
                    })
                    .catch(err => {
                        console.error('Error sending reply:', err);
                        alert('Failed to send reply. Please try again.');
                        sendReplyBtn.disabled = false;
                        sendReplyBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reply';
                    });
                });
            }

            function openModal(msgId, sender, date, content, isUnread, listItem, senderId){
                currentMsgId = msgId;
                currentListItem = listItem;
                currentSenderId = senderId;
                senderEl.textContent = sender;
                dateEl.textContent = date;
                contentEl.textContent = content;
                markReadBtn.style.display = isUnread ? 'inline-flex' : 'none';
                
                // Reset reply input
                if(replyInput){
                    replyInput.value = '';
                    replyCharCount.textContent = '0/10';
                    sendReplyBtn.disabled = true;
                    sendReplyBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reply';
                    sendReplyBtn.style.background = 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)';
                }
                
                modal.classList.add('show');
            }

            function closeModal(){
                modal.classList.remove('show');
                currentMsgId = null;
                currentListItem = null;
                currentSenderId = null;
            }

            function updateBadges(){
                // Update bell badge
                const badge = document.querySelector('#notifBtn .notif-badge');
                if(badge){
                    const count = parseInt(badge.textContent) - 1;
                    if(count <= 0){
                        badge.remove();
                    } else {
                        badge.textContent = count;
                    }
                }
                // Update header badge in panel
                const headerBadge = document.querySelector('.notif-header .badge');
                if(headerBadge){
                    const hCount = parseInt(headerBadge.textContent) - 1;
                    if(hCount <= 0){
                        headerBadge.remove();
                    } else {
                        headerBadge.textContent = hCount + ' new';
                    }
                }
            }

            function markAsRead(){
                if(!currentMsgId) return;
                
                fetch(`{% url 'violations:student_mark_message_read' 0 %}`.replace('/0/', `/${currentMsgId}/`), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status === 'ok'){
                        // Update list item styling
                        if(currentListItem){
                            currentListItem.classList.remove('unread');
                            currentListItem.style.background = '';
                            const dot = currentListItem.querySelector('.unread-dot');
                            if(dot) dot.remove();
                        }
                        // Hide mark as read button
                        markReadBtn.style.display = 'none';
                        // Update badges
                        updateBadges();
                    }
                })
                .catch(err => console.error('Error marking message read:', err));
            }

            // Close modal handlers
            if(closeBtn) closeBtn.addEventListener('click', closeModal);
            if(closeBtnFooter) closeBtnFooter.addEventListener('click', closeModal);
            if(modal) modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
            document.addEventListener('keydown', (e) => { if(e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });

            // Mark as read handler
            if(markReadBtn) markReadBtn.addEventListener('click', markAsRead);

            // Click on message items to view
            document.querySelectorAll('.message-item').forEach(item => {
                item.addEventListener('click', function(e){
                    // Don't open modal if clicking on a button inside
                    if(e.target.closest('button')) return;
                    
                    const msgId = this.dataset.messageId;
                    const sender = this.dataset.sender;
                    const date = this.dataset.date;
                    const content = this.dataset.content;
                    const isUnread = this.classList.contains('unread');
                    const senderId = this.dataset.senderId;
                    
                    openModal(msgId, sender, date, content, isUnread, this, senderId);
                });
            });
        })();
    </script>
    <script>
        // Trash panel toggle
        (function(){
            const btn = document.getElementById('trashBtn');
            const panel = document.getElementById('trashPanel');
            const closeBtn = document.getElementById('trashClose');
            if(btn && panel){ 
                btn.addEventListener('click', () => { panel.classList.toggle('show'); }); 
            }
            if(closeBtn && panel){
                closeBtn.addEventListener('click', () => { panel.classList.remove('show'); });
            }
        })();
    </script>
    <script>
        // Delete and Restore message functionality
        (function(){
            const csrfToken = '{{ csrf_token }}';
            
            // Delete message buttons
            document.querySelectorAll('.delete-msg-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const msgId = btn.dataset.msgId;
                    
                    if(!confirm('Move this message to trash?')) return;
                    
                    try {
                        const response = await fetch('{% url "violations:student_delete_message" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ message_id: msgId })
                        });
                        
                        if(response.ok) {
                            // Remove the item from the list and reload
                            location.reload();
                        } else {
                            alert('Failed to delete message');
                        }
                    } catch(err) {
                        console.error('Error deleting message:', err);
                        alert('Error deleting message');
                    }
                });
            });
            
            // Restore message buttons
            document.querySelectorAll('.restore-msg-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const msgId = btn.dataset.msgId;
                    
                    try {
                        const response = await fetch('{% url "violations:student_restore_message" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({ message_id: msgId })
                        });
                        
                        if(response.ok) {
                            location.reload();
                        } else {
                            alert('Failed to restore message');
                        }
                    } catch(err) {
                        console.error('Error restoring message:', err);
                        alert('Error restoring message');
                    }
                });
            });
        })();
    </script>
    <script>
        // Violation Details Modal functionality
        (function(){
            const modal = document.getElementById('violationModal');
            const closeBtn = document.getElementById('violationModalClose');
            const closeBtnFooter = document.getElementById('violationModalCloseBtn');
            
            // Elements to populate
            const typeBadge = document.getElementById('violationTypeBadge');
            const statusBadge = document.getElementById('violationStatusBadge');
            const incidentDate = document.getElementById('violationIncidentDate');
            const reportedDate = document.getElementById('violationReportedDate');
            const reporter = document.getElementById('violationReporter');
            const locationEl = document.getElementById('violationLocation');
            const description = document.getElementById('violationDescription');
            const witnessSection = document.getElementById('witnessSection');
            const witness = document.getElementById('violationWitness');
            const evidenceSection = document.getElementById('evidenceSection');
            const evidence = document.getElementById('violationEvidence');
            
            function openModal(row) {
                // Get data from row
                const type = row.dataset.type;
                const typeRaw = row.dataset.typeRaw;
                const status = row.dataset.status;
                const statusRaw = row.dataset.statusRaw;
                
                // Set type badge
                typeBadge.textContent = type;
                if(typeRaw === 'major') {
                    typeBadge.style.background = '#fee2e2';
                    typeBadge.style.color = '#b91c1c';
                } else {
                    typeBadge.style.background = '#e0e7ff';
                    typeBadge.style.color = '#3730a3';
                }
                
                // Set status badge
                statusBadge.textContent = status;
                if(statusRaw === 'reported') {
                    statusBadge.style.background = '#fff7ed';
                    statusBadge.style.color = '#9a3412';
                } else if(statusRaw === 'under_review') {
                    statusBadge.style.background = '#fef9c3';
                    statusBadge.style.color = '#854d0e';
                } else if(statusRaw === 'resolved') {
                    statusBadge.style.background = '#dcfce7';
                    statusBadge.style.color = '#166534';
                } else {
                    statusBadge.style.background = '#f3f4f6';
                    statusBadge.style.color = '#374151';
                }
                
                // Set other fields
                incidentDate.textContent = row.dataset.incidentDate || '—';
                reportedDate.textContent = row.dataset.date || '—';
                reporter.textContent = row.dataset.reporter || '—';
                locationEl.textContent = row.dataset.location || '—';
                description.textContent = row.dataset.description || '—';
                
                // Witness statement
                const witnessText = row.dataset.witness;
                if(witnessText && witnessText.trim()) {
                    witnessSection.style.display = 'block';
                    witness.textContent = witnessText;
                } else {
                    witnessSection.style.display = 'none';
                }
                
                // Evidence
                const evidenceUrl = row.dataset.evidence;
                if(evidenceUrl && evidenceUrl.trim()) {
                    evidenceSection.style.display = 'block';
                    evidence.href = evidenceUrl;
                } else {
                    evidenceSection.style.display = 'none';
                }
                
                modal.classList.add('show');
            }
            
            function closeModal() {
                modal.classList.remove('show');
            }
            
            // Close handlers
            if(closeBtn) closeBtn.addEventListener('click', closeModal);
            if(closeBtnFooter) closeBtnFooter.addEventListener('click', closeModal);
            if(modal) modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
            document.addEventListener('keydown', (e) => { if(e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });
            
            // Click on view buttons
            document.querySelectorAll('.view-violation-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const row = btn.closest('.violation-row');
                    if(row) openModal(row);
                });
            });
        })();
    </script>
</body>
</html>
