{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - CHMSU Student Violation Tracker</title>
        <link rel="stylesheet" href="{% static 'violations/css/style.css' %}" />
        <link rel="stylesheet" href="{% static 'violations/css/main.css' %}" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>
<body class="role-student">
    <!-- Top Navigation -->
    <header class="top-nav">
        <div class="top-left">
            <img src="{% static 'violations/images/chmsu_logo.png' %}" class="header-logo" alt="CHMSU" />
            <span class="header-title">Student Dashboard</span>
        </div>
        <div class="top-right">
            <button class="icon-btn" id="notifBtn" aria-label="Notifications" style="position:relative;">
                <i class="fas fa-bell"></i>
                {% if unread_count %}
                <span class="notif-badge" style="position:absolute; top:2px; right:2px; background:#dc2626; color:#fff; font-size:10px; padding:2px 5px; border-radius:10px; line-height:1;">{{ unread_count }}</span>
                {% endif %}
            </button>
            <div class="profile-menu">
                <button class="profile-btn" id="profileBtn">
                    <span class="avatar">{{ request.user.first_name|default:request.user.username|first|upper }}</span>
                    <span class="name">{{ request.user.first_name|default:request.user.username }}</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown" id="profileDropdown">
                    <a href="#">View Profile</a>
                    <a href="{% url 'violations:auth_logout' %}">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <div class="background-overlay"></div>
    <div class="background-image"></div>

    <main class="container" style="position:relative; z-index:3; margin-top: calc(var(--header-height) + 24px);">
        <!-- Welcome -->
        <section class="card" style="margin-bottom:16px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;">
                <div>
                    <h2 style="margin-bottom:4px;">Welcome{% if request.user.first_name %}, {{ request.user.first_name }}{% endif %}!</h2>
                    <p style="color:#667085;">Logged in as <strong>{{ request.user.username }}</strong></p>
                </div>
                <a href="{% url 'violations:auth_logout' %}" class="ghost-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </section>

        <!-- Quick Stats -->
        <section class="dashboard-grid">
            <div class="dash-card">
                <div class="card-icon"><i class="fas fa-list"></i></div>
                <div class="card-title">Total Violations</div>
                <div class="card-metric">{{ violations|length }}</div>
            </div>
            <div class="dash-card">
                <div class="card-icon"><i class="fas fa-triangle-exclamation"></i></div>
                <div class="card-title">Latest Status</div>
                <div class="card-desc">{% if violations and violations.0 %}{{ violations.0.get_status_display }}{% else %}None{% endif %}</div>
            </div>
            <div class="dash-card clickable" id="loginHistoryCard" role="button" tabindex="0" title="View login history">
                <div class="card-icon"><i class="fas fa-right-to-bracket"></i></div>
                <div class="card-title">Logged in History</div>
                <div class="card-desc">{% if request.user.last_login %}{{ request.user.last_login|date:"M d, Y H:i" }}{% else %}—{% endif %}</div>
            </div>
            <div class="dash-card">
                <div class="card-icon"><i class="fas fa-scale-balanced"></i></div>
                <div class="card-title">Standing</div>
                <div class="card-desc">{% if violations|length %}Under Monitoring{% else %}Good Standing{% endif %}</div>
            </div>
        </section>

        <!-- Two-column layout: Profile + Violations -->
        <section class="grid-2" style="display:grid; grid-template-columns: 1fr 2fr; gap:16px; margin-top:16px;">
            <!-- Profile Card -->
            <aside class="card">
                <h3 style="margin-bottom:12px;">Your Information</h3>
                <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                    {% if student and student.profile_image %}
                        <img src="{{ student.profile_image.url }}" alt="Profile" style="width:64px; height:64px; border-radius:50%; object-fit:cover;" />
                    {% else %}
                        <div style="width:64px; height:64px; border-radius:50%; background:#eef2ff; color:#4f46e5; display:flex; align-items:center; justify-content:center; font-weight:600;">
                            {{ request.user.first_name|default:request.user.username|first|upper }}
                        </div>
                    {% endif %}
                    <div>
                        <div style="font-weight:600;">{{ request.user.get_full_name|default:request.user.username }}</div>
                        <div style="color:#667085; font-size: 0.9rem;">{{ student.program|default:'No program set' }}</div>
                    </div>
                </div>
                <div class="form-grid">
                    <div>
                        <p><strong>Student ID:</strong> {{ student.student_id|default:'—' }}</p>
                        <p><strong>Year Level:</strong> {{ student.year_level|default:'—' }}</p>
                        <p><strong>Status:</strong> {{ student.enrollment_status|default:'—' }}</p>
                    </div>
                    <div>
                        <p><strong>Department:</strong> {{ student.department|default:'—' }}</p>
                        <p><strong>Contact:</strong> {{ student.contact_number|default:'—' }}</p>
                        <p><strong>Guardian:</strong> {{ student.guardian_name|default:'—' }}</p>
                    </div>
                </div>
            </aside>

            <!-- Violations Table -->
            <section class="card">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                    <h3>Your Violations</h3>
                    <span class="badge badge-warning">{{ violations|length }} records</span>
                </div>
                {% if violations %}
                <div class="table-responsive" style="margin-top: 10px;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Reported By</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for v in violations %}
                            <tr>
                                <td>{{ v.created_at|date:"M d, Y" }}</td>
                                <td>
                                    {% if v.type == 'major' %}
                                        <span class="badge" style="background:#fee2e2; color:#b91c1c;">{{ v.get_type_display }}</span>
                                    {% else %}
                                        <span class="badge" style="background:#e0e7ff; color:#3730a3;">{{ v.get_type_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if v.status == 'reported' %}
                                        <span class="badge" style="background:#fff7ed; color:#9a3412;">{{ v.get_status_display }}</span>
                                    {% elif v.status == 'under_review' %}
                                        <span class="badge" style="background:#fef9c3; color:#854d0e;">{{ v.get_status_display }}</span>
                                    {% elif v.status == 'resolved' %}
                                        <span class="badge" style="background:#dcfce7; color:#166534;">{{ v.get_status_display }}</span>
                                    {% else %}
                                        <span class="badge" style="background:#f3f4f6; color:#374151;">{{ v.get_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ v.reporter.get_full_name|default:v.reporter.username }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p style="color:#555; margin-top:8px;">No violations found. Keep up the good conduct!</p>
                {% endif %}
            </section>
        </section>
    </main>

    <!-- Notifications Panel -->
    <aside class="notif-panel" id="notifPanel" aria-hidden="true">
        <div class="notif-header">
            <h3>Messages {% if unread_count %}<span class="badge badge-danger" style="font-size:12px; margin-left:6px;">{{ unread_count }} new</span>{% endif %}</h3>
            <button class="icon-btn" id="notifClose"><i class="fas fa-times"></i></button>
        </div>
        <ul class="notif-list" style="max-height:400px; overflow-y:auto; padding:0; margin:0;">
            {% if staff_messages %}
                {% for msg in staff_messages %}
                <li class="message-item {% if not msg.read_at %}unread{% endif %}" 
                    data-message-id="{{ msg.id }}"
                    data-sender="{{ msg.sender.get_full_name|default:msg.sender.username }}"
                    data-date="{{ msg.created_at|date:'M d, Y H:i' }}"
                    data-content="{{ msg.content }}"
                    style="padding:12px; border-bottom:1px solid #eee; cursor:pointer; {% if not msg.read_at %}background:#f0fdf4;{% endif %}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:6px;">
                        <strong style="color:var(--chmsu-dark-green);">
                            <i class="fas fa-user-tie"></i> {{ msg.sender.get_full_name|default:msg.sender.username }}
                        </strong>
                        <small style="color:#667085;">{{ msg.created_at|date:"M d, H:i" }}</small>
                    </div>
                    <p style="margin:0; color:#344054; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ msg.content|truncatechars:50 }}</p>
                    {% if not msg.read_at %}
                    <span class="unread-dot" style="display:inline-block; width:8px; height:8px; background:#dc2626; border-radius:50%; margin-top:6px;"></span>
                    {% endif %}
                </li>
                {% endfor %}
            {% else %}
                <li style="padding:12px; color:#667085; text-align:center;">
                    <i class="fas fa-inbox"></i> No messages yet.
                </li>
            {% endif %}
        </ul>
    </aside>

    <!-- Message View Modal -->
    <div class="modal" id="messageViewModal" aria-hidden="true">
        <div class="modal-card" style="max-width:500px;">
            <div class="modal-header">
                <h3><i class="fas fa-envelope-open"></i> Message</h3>
                <button class="icon-btn" id="msgViewClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #eee;">
                    <div>
                        <strong style="color:var(--chmsu-dark-green); font-size:16px;">
                            <i class="fas fa-user-tie"></i> <span id="msgViewSender">—</span>
                        </strong>
                        <div style="color:#667085; font-size:13px; margin-top:4px;">OSA Staff</div>
                    </div>
                    <small style="color:#667085;" id="msgViewDate">—</small>
                </div>
                <div id="msgViewContent" style="color:#344054; line-height:1.6; white-space:pre-wrap;">
                    —
                </div>
            </div>
            <div class="modal-actions" style="display:flex; gap:10px; justify-content:flex-end;">
                <button class="login-button" id="msgViewMarkRead" style="display:none; background:linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fas fa-check"></i> Mark as Read
                </button>
                <button class="login-button" id="msgViewCloseBtn" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Login History Modal -->
    <div class="modal" id="loginHistoryModal" aria-hidden="true">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Logged in History</h3>
                <button class="icon-btn" id="loginHistClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p><strong>Last login:</strong> {% if request.user.last_login %}{{ request.user.last_login|date:"M d, Y H:i" }}{% else %}—{% endif %}</p>
                <p><strong>Account created:</strong> {{ request.user.date_joined|date:"M d, Y H:i" }}</p>
                <div style="margin-top:10px;">
                    <h4 style="margin:6px 0 8px;">Your Login History</h4>
                    {% if login_history %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="min-width:140px;">Time</th>
                                        <th>Event</th>
                                        <th>IP</th>
                                        <th>User Agent</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for entry in login_history %}
                                    <tr>
                                        <td>{{ entry.timestamp|date:"M d, Y H:i" }}</td>
                                        <td>{{ entry.get_event_type_display }}</td>
                                        <td>{{ entry.ip_address|default:'—' }}</td>
                                        <td style="max-width:360px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ entry.user_agent|default:'—' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p style="color:#667085;">No login events recorded yet.</p>
                    {% endif %}
                </div>
            </div>
            <div class="modal-actions">
                <button class="login-button" id="loginHistCloseBtn" style="background:linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <script src="{% static 'violations/js/script.js' %}"></script>
    <script>
        // Message View Modal functionality
        (function(){
            const modal = document.getElementById('messageViewModal');
            const closeBtn = document.getElementById('msgViewClose');
            const closeBtnFooter = document.getElementById('msgViewCloseBtn');
            const markReadBtn = document.getElementById('msgViewMarkRead');
            const senderEl = document.getElementById('msgViewSender');
            const dateEl = document.getElementById('msgViewDate');
            const contentEl = document.getElementById('msgViewContent');
            
            let currentMsgId = null;
            let currentListItem = null;

            function openModal(msgId, sender, date, content, isUnread, listItem){
                currentMsgId = msgId;
                currentListItem = listItem;
                senderEl.textContent = sender;
                dateEl.textContent = date;
                contentEl.textContent = content;
                markReadBtn.style.display = isUnread ? 'inline-flex' : 'none';
                modal.classList.add('show');
            }

            function closeModal(){
                modal.classList.remove('show');
                currentMsgId = null;
                currentListItem = null;
            }

            function updateBadges(){
                // Update bell badge
                const badge = document.querySelector('#notifBtn .notif-badge');
                if(badge){
                    const count = parseInt(badge.textContent) - 1;
                    if(count <= 0){
                        badge.remove();
                    } else {
                        badge.textContent = count;
                    }
                }
                // Update header badge in panel
                const headerBadge = document.querySelector('.notif-header .badge');
                if(headerBadge){
                    const hCount = parseInt(headerBadge.textContent) - 1;
                    if(hCount <= 0){
                        headerBadge.remove();
                    } else {
                        headerBadge.textContent = hCount + ' new';
                    }
                }
            }

            function markAsRead(){
                if(!currentMsgId) return;
                
                fetch(`{% url 'violations:student_mark_message_read' 0 %}`.replace('/0/', `/${currentMsgId}/`), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if(data.status === 'ok'){
                        // Update list item styling
                        if(currentListItem){
                            currentListItem.classList.remove('unread');
                            currentListItem.style.background = '';
                            const dot = currentListItem.querySelector('.unread-dot');
                            if(dot) dot.remove();
                        }
                        // Hide mark as read button
                        markReadBtn.style.display = 'none';
                        // Update badges
                        updateBadges();
                    }
                })
                .catch(err => console.error('Error marking message read:', err));
            }

            // Close modal handlers
            if(closeBtn) closeBtn.addEventListener('click', closeModal);
            if(closeBtnFooter) closeBtnFooter.addEventListener('click', closeModal);
            if(modal) modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
            document.addEventListener('keydown', (e) => { if(e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });

            // Mark as read handler
            if(markReadBtn) markReadBtn.addEventListener('click', markAsRead);

            // Click on message items to view
            document.querySelectorAll('.message-item').forEach(item => {
                item.addEventListener('click', function(e){
                    // Don't open modal if clicking on a button inside
                    if(e.target.closest('button')) return;
                    
                    const msgId = this.dataset.messageId;
                    const sender = this.dataset.sender;
                    const date = this.dataset.date;
                    const content = this.dataset.content;
                    const isUnread = this.classList.contains('unread');
                    
                    openModal(msgId, sender, date, content, isUnread, this);
                });
            });
        })();
    </script>
</body>
</html>
